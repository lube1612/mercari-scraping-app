# スプレッドシート連携システム - 実装プロセス

## 🎯 目標

スプレッドシートに検索条件を入力して、「スタート」ボタンを押すと、検索結果がスプレッドシート上に反映されるシステムを構築する。

## 📋 実装プロセスの全体像

```
┌─────────────────────────────────────────────────────────┐
│  ステップ1: スプレッドシートの準備                        │
│  - 入力項目の設定                                        │
│  - ボタンの配置                                          │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  ステップ2: APIサーバーの構築                             │
│  - PythonスクリプトをAPI化                               │
│  - スプレッドシートから呼び出せるようにする                │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  ステップ3: スプレッドシートとAPIの連携                   │
│  - Google Apps ScriptでAPIを呼び出す                     │
│  - 結果をスプレッドシートに書き込む                        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│  ステップ4: テストとデバッグ                              │
│  - 動作確認                                              │
│  - エラーハンドリングの実装                              │
└─────────────────────────────────────────────────────────┘
```

## 🔧 実装方法の選択肢

### 方法A: Googleスプレッドシート + Google Cloud Functions（推奨）⭐

**メリット:**
- ✅ Googleスプレッドシートから直接実行可能
- ✅ クラウドベースでどこからでもアクセス可能
- ✅ 複数人で共有可能
- ✅ スケーラブル

**デメリット:**
- ⚠️ Google Cloud Functionsのセットアップが必要
- ⚠️ コストがかかる可能性（無料枠あり）

### 方法B: Googleスプレッドシート + ローカルAPIサーバー

**メリット:**
- ✅ ローカル環境で動作
- ✅ コストがかからない

**デメリット:**
- ❌ 常にローカルPCが起動している必要がある
- ❌ 外部からアクセスできない

### 方法C: Excel + VBA + Pythonスクリプト

**メリット:**
- ✅ Excelから直接実行可能
- ✅ ローカル環境で動作

**デメリット:**
- ❌ Windows環境が前提
- ❌ セットアップが複雑

## 🚀 推奨実装: Googleスプレッドシート + Google Cloud Functions

### ステップ1: APIサーバーの作成（Python）

**`api_server.py` を作成**

```python
from flask import Flask, request, jsonify
from mercari.scraper import MercariScraper
import os

app = Flask(__name__)

@app.route('/api/scrape', methods=['POST'])
def scrape_mercari():
    """
    メルカリスクレイピングAPI
    
    Request Body:
    {
        "keyword": "ポケモンカード",
        "max_items": 5
    }
    
    Response:
    {
        "success": true,
        "items": [...],
        "count": 5
    }
    """
    data = request.json
    keyword = data.get('keyword', 'ポケモンカード')
    max_items = data.get('max_items', 5)
    
    # 環境変数を設定
    if os.path.exists(os.path.expanduser('~/playwright-browsers')):
        os.environ['PLAYWRIGHT_BROWSERS_PATH'] = os.path.expanduser('~/playwright-browsers')
    
    try:
        items_data = []
        
        with MercariScraper(headless=True) as scraper:
            target_url = f"https://www.mercari.com/jp/search/?keyword={keyword}"
            item_links = scraper.scrape_list(target_url)
            
            for i, item_url in enumerate(item_links[:max_items]):
                item_info = scraper.scrape_detail(item_url)
                if item_info:
                    items_data.append(item_info)
        
        return jsonify({
            "success": True,
            "items": items_data,
            "count": len(items_data)
        })
    
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### ステップ2: Google Cloud Functionsにデプロイ

**`main.py` (Cloud Functions用) を作成**

```python
from flask import Flask, request, jsonify
from mercari.scraper import MercariScraper
import os

def scrape_mercari(request):
    """
    Google Cloud Functions用のエントリーポイント
    """
    # リクエストデータを取得
    request_json = request.get_json(silent=True)
    keyword = request_json.get('keyword', 'ポケモンカード') if request_json else 'ポケモンカード'
    max_items = request_json.get('max_items', 5) if request_json else 5
    
    # 環境変数を設定
    if os.path.exists('/tmp/playwright-browsers'):
        os.environ['PLAYWRIGHT_BROWSERS_PATH'] = '/tmp/playwright-browsers'
    
    try:
        items_data = []
        
        with MercariScraper(headless=True) as scraper:
            target_url = f"https://www.mercari.com/jp/search/?keyword={keyword}"
            item_links = scraper.scrape_list(target_url)
            
            for i, item_url in enumerate(item_links[:max_items]):
                item_info = scraper.scrape_detail(item_url)
                if item_info:
                    items_data.append(item_info)
        
        return jsonify({
            "success": True,
            "items": items_data,
            "count": len(items_data)
        })
    
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500
```

**`requirements.txt` (Cloud Functions用)**

```
flask>=2.0.0
playwright>=1.40.0
```

### ステップ3: Googleスプレッドシートの設定

**スプレッドシートのレイアウト:**

```
A1: 検索キーワード
B1: ポケモンカード

A2: 取得件数
B2: 5

A3: [スタート] ボタン（画像または図形）

A5: タイトル
B5: 価格
C5: URL
D5: 説明
...
```

**Google Apps Script (`Code.gs`):**

```javascript
/**
 * スクレイピング実行関数
 */
function runScraping() {
  var sheet = SpreadsheetApp.getActiveSheet();
  
  // 入力値を取得
  var keyword = sheet.getRange('B1').getValue();
  var maxItems = sheet.getRange('B2').getValue();
  
  if (!keyword) {
    SpreadsheetApp.getUi().alert('検索キーワードを入力してください。');
    return;
  }
  
  // APIエンドポイント（Google Cloud FunctionsのURL）
  var apiUrl = 'https://YOUR-REGION-YOUR-PROJECT.cloudfunctions.net/scrape_mercari';
  
  // リクエストデータ
  var payload = {
    'keyword': keyword,
    'max_items': maxItems
  };
  
  var options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };
  
  try {
    // 実行中メッセージ
    SpreadsheetApp.getUi().alert('スクレイピングを実行中です。\n完了までしばらくお待ちください。');
    
    // APIを呼び出し
    var response = UrlFetchApp.fetch(apiUrl, options);
    var result = JSON.parse(response.getContentText());
    
    if (result.success) {
      // 結果をスプレッドシートに書き込む
      writeResultsToSheet(sheet, result.items);
      SpreadsheetApp.getUi().alert('完了しました！\n' + result.count + '件の商品情報を取得しました。');
    } else {
      SpreadsheetApp.getUi().alert('エラーが発生しました:\n' + result.error);
    }
  } catch (e) {
    SpreadsheetApp.getUi().alert('エラーが発生しました:\n' + e.toString());
  }
}

/**
 * 結果をスプレッドシートに書き込む
 */
function writeResultsToSheet(sheet, items) {
  // ヘッダーを設定
  var headers = ['タイトル', '価格', 'URL', '説明', '画像URL'];
  sheet.getRange(5, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(5, 1, 1, headers.length).setFontWeight('bold');
  
  // 既存のデータをクリア
  var lastRow = sheet.getLastRow();
  if (lastRow > 5) {
    sheet.getRange(6, 1, lastRow - 5, headers.length).clear();
  }
  
  // データを書き込む
  if (items && items.length > 0) {
    var data = [];
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      data.push([
        item.title || '',
        item.price || '',
        item.url || '',
        item.description || '',
        item.image_url || ''
      ]);
    }
    sheet.getRange(6, 1, data.length, headers.length).setValues(data);
    
    // URLをリンクとして設定
    for (var i = 0; i < data.length; i++) {
      var urlCell = sheet.getRange(6 + i, 3);
      if (data[i][2]) {
        urlCell.setFormula('=HYPERLINK("' + data[i][2] + '","' + data[i][2] + '")');
      }
    }
  }
}

/**
 * メニューを追加
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('スクレイピング')
    .addItem('スタート', 'runScraping')
    .addToUi();
}
```

### ステップ4: ボタンの設定

1. **スプレッドシートに図形を挿入**
   - 挿入 > 図形 > 四角形
   - 「スタート」とテキストを入力

2. **スクリプトを割り当て**
   - 図形を右クリック
   - 「スクリプトを割り当て」を選択
   - `runScraping` を入力

## 📝 実装の詳細ステップ

### Phase 1: ローカル環境でのテスト

1. **APIサーバーをローカルで起動**
   ```bash
   python3 api_server.py
   ```

2. **Google Apps ScriptでローカルAPIをテスト**
   - `apiUrl` を `http://localhost:5000/api/scrape` に設定
   - ngrokなどでトンネルを作成（外部アクセス用）

### Phase 2: Google Cloud Functionsへのデプロイ

1. **Google Cloud Projectを作成**
2. **Cloud Functionsにデプロイ**
   ```bash
   gcloud functions deploy scrape_mercari \
     --runtime python39 \
     --trigger-http \
     --allow-unauthenticated
   ```

3. **API URLを取得**
   - Cloud FunctionsのURLをコピー

### Phase 3: スプレッドシートとの連携

1. **Google Apps Scriptを更新**
   - API URLをCloud FunctionsのURLに変更

2. **動作確認**
   - スプレッドシートで「スタート」ボタンをクリック
   - 結果が表示されることを確認

## 🔧 代替案: より簡単な実装（ローカルAPI + ngrok）

### ステップ1: ローカルAPIサーバーを起動

```bash
python3 api_server.py
```

### ステップ2: ngrokでトンネルを作成

```bash
ngrok http 5000
```

### ステップ3: Google Apps ScriptでngrokのURLを使用

```javascript
var apiUrl = 'https://YOUR-NGROK-URL.ngrok.io/api/scrape';
```

**メリット:**
- ✅ セットアップが簡単
- ✅ コストがかからない

**デメリット:**
- ❌ ngrokのURLが変わる（無料版）
- ❌ ローカルPCが起動している必要がある

## 📊 実装の優先順位

### 優先度1: ローカル環境での動作確認
1. APIサーバーを作成
2. ローカルでテスト
3. Google Apps ScriptでローカルAPIを呼び出す

### 優先度2: クラウド環境への移行
1. Google Cloud Functionsにデプロイ
2. スプレッドシートと連携
3. 動作確認

### 優先度3: 機能の拡張
1. エラーハンドリングの強化
2. 進捗表示の追加
3. 複数キーワードの対応

## 🎯 次のステップ

1. **APIサーバーを作成** (`api_server.py`)
2. **ローカルでテスト**
3. **Google Apps Scriptを作成**
4. **スプレッドシートで動作確認**
5. **必要に応じてクラウドにデプロイ**

詳細な実装コードは、次のステップで作成します。
