# Playwrightダウンロード失敗の徹底調査と解決策

## 🔍 調査結果

### 現在の環境状況

1. **Playwrightバージョン**: 1.57.0 ✓
2. **Pythonバージョン**: 3.14.2 ✓
3. **ブラウザの保存場所**: `~/Library/Caches/ms-playwright/` ✓
4. **chromium-1200ディレクトリ**: **既に存在している** ✓

### 発見された問題

1. **ZIPファイルのダウンロードが24バイトしかない**
   - 原因: `GatewayExceptionResponse`エラーが返されている
   - サーバー側の問題、またはSSL証明書の問題の可能性

2. **curlでSSL証明書エラー**
   - `curl: (77) error setting certificate verify locations`
   - macOSのSSL証明書の設定に問題がある可能性

3. **既にブラウザがインストールされている可能性**
   - `chromium-1200`ディレクトリが存在
   - 実行ファイルが正しく配置されているか確認が必要

## ✅ 解決策

### 解決策1: 既存のインストールを確認（最優先）

**既にブラウザがインストールされている可能性が高いです。**

以下のコマンドで確認：

```bash
# 実行ファイルの存在確認
ls -la ~/Library/Caches/ms-playwright/chromium-1200/chrome-mac-x64/"Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing"

# ブラウザの起動テスト
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ 成功'); browser.close(); p.stop()"
```

**もし成功したら、既にインストール済みです！** スクレイピングを開始できます。

### 解決策2: Playwrightの公式インストールコマンドを使用

**手動ダウンロードで失敗している場合、公式コマンドが最も確実です。**

```bash
python3 -m playwright install chromium
```

このコマンドは：
- 正しいバージョンを自動検出
- SSL証明書の問題を回避
- 正しい場所に自動配置
- エラーハンドリングが充実

### 解決策3: SSL証明書の問題を回避

**curlでSSL証明書エラーが発生する場合：**

```bash
# SSL証明書の検証をスキップ（開発環境のみ）
curl -k -L -o chromium-mac-x64.zip https://playwright.azureedge.net/builds/chromium/1200/chromium-mac-x64.zip
```

**ただし、これは推奨されません。** 公式コマンドを使用する方が安全です。

### 解決策4: プロキシ環境の場合

**企業ネットワークなどでプロキシを使用している場合：**

```bash
# プロキシを設定してインストール
HTTPS_PROXY=https://プロキシのアドレス:ポート python3 -m playwright install chromium
```

## 🎯 推奨される手順

### ステップ1: 既存のインストールを確認

```bash
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ ブラウザの起動に成功しました！'); browser.close(); p.stop()"
```

**成功した場合**: 既にインストール済みです。次のステップに進んでください。

**失敗した場合**: ステップ2に進んでください。

### ステップ2: 公式コマンドでインストール

```bash
python3 -m playwright install chromium
```

このコマンドが最も確実です。

### ステップ3: インストール確認

```bash
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ 成功'); browser.close(); p.stop()"
```

### ステップ4: スクレイピングを開始

```bash
python3 mercari/scrape.py
```

## 📊 問題の根本原因

1. **手動ダウンロードの問題**
   - URLが正しくても、サーバー側でエラーが返される
   - SSL証明書の問題
   - ネットワーク環境の問題

2. **推奨される方法**
   - Playwrightの公式インストールコマンドを使用
   - 自動的に正しいバージョンとURLを選択
   - エラーハンドリングが充実

## 🔧 トラブルシューティング

### 問題: 公式コマンドでも失敗する場合

1. **ネットワーク接続を確認**
   ```bash
   ping playwright.azureedge.net
   ```

2. **ファイアウォールの設定を確認**
   - 企業ネットワークの場合、管理者に相談

3. **別のネットワークで試す**
   - モバイルホットスポットなど

### 問題: 権限エラーが発生する場合

```bash
# ディレクトリの権限を確認
ls -la ~/Library/Caches/ms-playwright/

# 必要に応じて権限を変更
chmod -R 755 ~/Library/Caches/ms-playwright/
```

## 📝 まとめ

**最も確実な方法：**

1. 既存のインストールを確認
2. なければ `python3 -m playwright install chromium` を実行
3. インストール確認
4. スクレイピング開始

**手動ダウンロードは避ける：**
- サーバー側の問題で失敗しやすい
- バージョンの不一致が発生しやすい
- SSL証明書の問題が発生しやすい
