# Playwrightブラウザインストール - 実行手順（最終版）

## 🔍 問題の原因（徹底調査結果）

1. **chromium-1200ディレクトリは存在するが、中身が空**
   - ディレクトリは作成されているが、実行ファイルが配置されていない

2. **手動ダウンロードが失敗**
   - ZIPファイルが24バイトしかダウンロードされない
   - `GatewayExceptionResponse`エラーが発生
   - SSL証明書の問題の可能性

3. **権限エラーが発生**
   - `EPERM: operation not permitted`エラー
   - ディレクトリのロックファイル作成に失敗

## ✅ 確実な解決方法

### ステップ1: 権限の問題を解決

**Cursorのターミナルで以下のコマンドを実行：**

```bash
# 既存のロックファイルを削除（存在する場合）
rm -rf ~/Library/Caches/ms-playwright/__dirlock

# ディレクトリの権限を確認
ls -la ~/Library/Caches/ms-playwright/

# 必要に応じて権限を変更
chmod -R 755 ~/Library/Caches/ms-playwright/
```

### ステップ2: Playwrightの公式インストールコマンドを実行

**Cursorのターミナルで以下のコマンドを実行：**

```bash
python3 -m playwright install chromium
```

**実行時の注意：**
- インターネット接続が必要です
- 約150-200MBのダウンロードがあります
- 数分かかる場合があります
- 進捗が表示されます

**もし権限エラーが発生した場合：**

```bash
# 管理者権限で実行（macOSの場合）
sudo python3 -m playwright install chromium
```

**または、ユーザーディレクトリにインストール：**

```bash
# 環境変数を設定してユーザーディレクトリにインストール
export PLAYWRIGHT_BROWSERS_PATH=~/playwright-browsers
python3 -m playwright install chromium
```

### ステップ3: インストール確認

```bash
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ ブラウザの起動に成功しました！'); browser.close(); p.stop()"
```

**成功した場合**: 次のステップに進んでください。

**失敗した場合**: トラブルシューティングセクションを参照してください。

### ステップ4: スクレイピングを開始

```bash
python3 mercari/scrape.py
```

## 🔧 トラブルシューティング

### 問題1: 権限エラーが続く場合

**解決方法1: ディレクトリを削除して再作成**

```bash
# 既存のディレクトリを削除
rm -rf ~/Library/Caches/ms-playwright/

# ディレクトリを再作成
mkdir -p ~/Library/Caches/ms-playwright/

# 権限を設定
chmod 755 ~/Library/Caches/ms-playwright/

# 再度インストール
python3 -m playwright install chromium
```

**解決方法2: 別の場所にインストール**

```bash
# 環境変数を設定
export PLAYWRIGHT_BROWSERS_PATH=~/playwright-browsers

# インストール
python3 -m playwright install chromium

# インストール確認
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ 成功'); browser.close(); p.stop()"
```

### 問題2: ネットワークエラーが発生する

**解決方法：**

1. **インターネット接続を確認**
   ```bash
   ping playwright.azureedge.net
   ```

2. **プロキシを使用している場合**
   ```bash
   HTTPS_PROXY=https://プロキシのアドレス:ポート python3 -m playwright install chromium
   ```

### 問題3: SSL証明書エラーが発生する

**解決方法：**

```bash
# 一時的にSSL検証をスキップ（開発環境のみ）
export PYTHONHTTPSVERIFY=0
python3 -m playwright install chromium
```

## 📋 一括実行コマンド（コピー&ペースト用）

**以下のコマンドを順番に実行してください：**

```bash
# 1. 既存のロックファイルを削除
rm -rf ~/Library/Caches/ms-playwright/__dirlock

# 2. 権限を確認・設定
chmod -R 755 ~/Library/Caches/ms-playwright/ 2>/dev/null || true

# 3. Playwrightのブラウザをインストール
python3 -m playwright install chromium

# 4. インストール確認
python3 -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('✓ ブラウザの起動に成功しました！'); browser.close(); p.stop()"
```

## 🎯 まとめ

**最も確実な方法：**

1. 権限の問題を解決（ロックファイルの削除、権限の設定）
2. `python3 -m playwright install chromium` を実行
3. インストール確認
4. スクレイピング開始

**手動ダウンロードは避ける：**
- サーバー側の問題で失敗しやすい
- SSL証明書の問題が発生しやすい
- バージョンの不一致が発生しやすい
